% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/validation.R
\name{sync_validation_submissions}
\alias{sync_validation_submissions}
\title{Synchronize Validation Statuses with KoboToolbox}
\usage{
sync_validation_submissions(log_threshold = logger::DEBUG)
}
\arguments{
\item{log_threshold}{The logging level threshold for the logger package (e.g., DEBUG, INFO).
Default is logger::DEBUG.}
}
\value{
None. The function performs status updates and database operations as side effects.
}
\description{
Synchronizes validation statuses between the local system and KoboToolbox by intelligently
processing validation flags and updating submission statuses only when necessary. This function
respects manual human approvals and avoids unnecessary API calls.
}
\details{
The function follows these steps:
\enumerate{
\item Downloads the current validation flags from cloud storage
\item Sets up parallel processing using the future package (max 4 workers with rate limiting)
\item Fetches current validation status from KoboToolbox for all submissions
\item Identifies manually approved submissions and preserves them (excludes system approvals)
\item Determines which flagged submissions need updating (excludes manual approvals and already correct)
\item Determines which clean submissions need updating (only those not already approved)
\item Updates only the submissions that need status changes
\item Combines updated and unchanged statuses
\item Adds KoboToolbox validation status to validation flags
\item Pushes all validation flags with KoboToolbox status to MongoDB for record-keeping
}

Progress reporting is enabled to track the status of submissions being processed.
}
\note{
This function requires proper configuration in the config file, including:
\itemize{
\item MongoDB connection parameters
\item KoboToolbox asset ID and token (configured under ingestion$kefs$koboform)
\item Google cloud storage parameters
}
}
\section{Manual Approval Preservation}{

The function identifies submissions that have been manually approved by humans (validated_by
is not empty and not the system username) and preserves these approvals even if automated
validation would flag them. This ensures human review decisions are respected.
}

\section{Rate Limiting}{

To avoid overwhelming the KoboToolbox API server (kf.fimskenya.co.ke), the function limits
parallel workers to 4 and adds a 200ms delay between requests. This provides approximately
20 requests per second across all workers while maintaining server stability.
}

\examples{
\dontrun{
# Run with default DEBUG logging
sync_validation_submissions()

# Run with INFO level logging
sync_validation_submissions(log_threshold = logger::INFO)
}

}
\keyword{validation}
\keyword{workflow}
