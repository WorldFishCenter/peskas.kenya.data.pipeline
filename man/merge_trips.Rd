% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/match-trips.R
\name{merge_trips}
\alias{merge_trips}
\title{Merge Survey and GPS Trip Data}
\usage{
merge_trips(conf)
}
\arguments{
\item{conf}{Configuration list from \code{read_config()} containing:
\itemize{
\item metadata$airtable$assets: Path to device registry
\item surveys$kefs$v2$validated$file_prefix: Path to validated surveys
\item surveys$kefs$v2$merged: Output path for merged data
\item pds$pds_trips$file_prefix: Path to preprocessed PDS trips data
\item pds$pds_trips$version: Version of PDS trips data to use
\item storage$google: Cloud storage settings (key, options, options_coasts)
}}
}
\value{
Invisible NULL. The function uploads a parquet file to cloud storage
containing all merged records with the following structure:
\itemize{
\item submission_id: Survey identifier (NA for unmatched trips)
\item landing_date: Landing date
\item imei: Device IMEI
\item n_fields_used, n_fields_ok, match_ok: Match quality indicators
\item trip: GPS trip identifier (NA for unmatched surveys)
\item started, ended: Trip timestamps
\item registration_number_survey, registration_number_trip
\item boat_name_survey, boat_name_trip
\item fisher_name_survey, fisher_name_trip
\item Additional survey and trip metadata
}

The uploaded dataset includes:
\itemize{
\item Matched survey-trip pairs (where both submission_id and trip are non-NA)
\item Unmatched surveys (trip = NA)
\item Unmatched trips (submission_id = NA)
}
}
\description{
End-to-end workflow for matching KEFS catch surveys to PDS GPS trips for
Kenya data. Loads device registry, validated surveys, and GPS trips, then
performs fuzzy matching, merges all records (matched and unmatched), and
uploads the result to cloud storage.
}
\details{
The function executes the following pipeline:
\enumerate{
\item \strong{Load device registry}: Downloads Airtable assets from cloud storage
and filters for Kenya devices (WorldFish - Kenya, Kenya, Kenya AABS)
\item \strong{Load validated surveys}: Downloads preprocessed and validated
KEFS v2 surveys from cloud storage
\item \strong{Load GPS trips}: Downloads preprocessed PDS trips data from cloud storage
using configured file prefix and version
\item \strong{Filter PDS surveys}: Selects only surveys where pds = "yes" or "pds"
\item \strong{Match surveys to trips}: Runs \code{match_surveys_to_gps_trips()}
with two-step fuzzy matching (surveys -> registry -> trips)
\item \strong{Merge with full datasets}: Combines matched subset with all
unmatched surveys and trips
\item \strong{Upload to cloud storage}: Saves merged data as versioned parquet file
}
}
\section{Logging}{

The function logs progress at each step:
\itemize{
\item Loading device registry
\item Loading validated surveys
\item Loading GPS trips from cloud storage
\item Number of PDS surveys being matched
\item Merging with full datasets
\item Final counts (total records and matched pairs)
\item Uploading merged data to cloud storage
}
}

\section{Pipeline Integration}{

This function is typically run after:
\enumerate{
\item \code{ingest_kefs_surveys_v2()} - Downloads raw data from Kobo
\item \code{preprocess_kefs_surveys_v2()} - Cleans and standardizes surveys
\item \code{validate_kefs_surveys_v2()} - Validates catch data
\item \code{ingest_pds_trips()} and \code{preprocess_pds_tracks()} - Preprocessed PDS trips data must be available in cloud storage
}

The output can be downloaded using:
\preformatted{
merged_data <- download_parquet_from_cloud(
  prefix = conf$surveys$kefs$v2$merged,
  provider = conf$storage$google$key,
  options = conf$storage$google$options
)
}
}

\examples{
\dontrun{
# Standard usage - merges and uploads to cloud
conf <- read_config()
merge_trips(conf)

# Download the merged data to analyze
merged_data <- download_parquet_from_cloud(
  prefix = conf$surveys$kefs$v2$merged,
  provider = conf$storage$google$key,
  options = conf$storage$google$options
)

# Count matched vs unmatched
table(
  survey = !is.na(merged_data$submission_id),
  trip = !is.na(merged_data$trip)
)
}

}
\keyword{matching}
\keyword{workflow}
