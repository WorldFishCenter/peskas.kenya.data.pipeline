<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Merge Survey and GPS Trip Data — merge_trips • peskas.kenya.data.pipeline</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/IBM_Plex_Sans-0.4.10/font.css" rel="stylesheet"><link href="../deps/Fira_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/Alegreya_Sans_SC-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Merge Survey and GPS Trip Data — merge_trips"><meta name="description" content="End-to-end workflow for matching KEFS catch surveys to PDS GPS trips for
Kenya data. Loads device registry, validated surveys, and GPS trips, then
performs fuzzy matching, merges all records (matched and unmatched), and
uploads the result to cloud storage."><meta property="og:description" content="End-to-end workflow for matching KEFS catch surveys to PDS GPS trips for
Kenya data. Loads device registry, validated surveys, and GPS trips, then
performs fuzzy matching, merges all records (matched and unmatched), and
uploads the result to cloud storage."><meta property="og:image" content="https://worldfishcenter.github.io/peskas.kenya.data.pipeline/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">peskas.kenya.data.pipeline</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Merge Survey and GPS Trip Data</h1>

      <div class="d-none name"><code>merge_trips.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>End-to-end workflow for matching KEFS catch surveys to PDS GPS trips for
Kenya data. Loads device registry, validated surveys, and GPS trips, then
performs fuzzy matching, merges all records (matched and unmatched), and
uploads the result to cloud storage.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">merge_trips</span><span class="op">(</span><span class="va">conf</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-conf">conf<a class="anchor" aria-label="anchor" href="#arg-conf"></a></dt>
<dd><p>Configuration list from <code><a href="read_config.html">read_config()</a></code> containing:</p><ul><li><p>metadata$airtable$assets: Path to device registry</p></li>
<li><p>surveys$kefs$v2$validated$file_prefix: Path to validated surveys</p></li>
<li><p>surveys$kefs$v2$merged: Output path for merged data</p></li>
<li><p>pds$pds_trips$file_prefix: Path to preprocessed PDS trips data</p></li>
<li><p>pds$pds_trips$version: Version of PDS trips data to use</p></li>
<li><p>storage$google: Cloud storage settings (key, options, options_coasts)</p></li>
</ul></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Invisible NULL. The function uploads a parquet file to cloud storage
containing all merged records with the following structure:</p><ul><li><p>submission_id: Survey identifier (NA for unmatched trips)</p></li>
<li><p>landing_date: Landing date</p></li>
<li><p>imei: Device IMEI</p></li>
<li><p>n_fields_used, n_fields_ok, match_ok: Match quality indicators</p></li>
<li><p>trip: GPS trip identifier (NA for unmatched surveys)</p></li>
<li><p>started, ended: Trip timestamps</p></li>
<li><p>registration_number_survey, registration_number_trip</p></li>
<li><p>boat_name_survey, boat_name_trip</p></li>
<li><p>fisher_name_survey, fisher_name_trip</p></li>
<li><p>Additional survey and trip metadata</p></li>
</ul><p>The uploaded dataset includes:</p><ul><li><p>Matched survey-trip pairs (where both submission_id and trip are non-NA)</p></li>
<li><p>Unmatched surveys (trip = NA)</p></li>
<li><p>Unmatched trips (submission_id = NA)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function executes the following pipeline:</p><ol><li><p><strong>Load device registry</strong>: Downloads Airtable assets from cloud storage
and filters for Kenya devices (WorldFish - Kenya, Kenya, Kenya AABS)</p></li>
<li><p><strong>Load validated surveys</strong>: Downloads preprocessed and validated
KEFS v2 surveys from cloud storage</p></li>
<li><p><strong>Load GPS trips</strong>: Downloads preprocessed PDS trips data from cloud storage
using configured file prefix and version</p></li>
<li><p><strong>Filter PDS surveys</strong>: Selects only surveys where pds = "yes" or "pds"</p></li>
<li><p><strong>Match surveys to trips</strong>: Runs <code><a href="match_surveys_to_gps_trips.html">match_surveys_to_gps_trips()</a></code>
with two-step fuzzy matching (surveys -&gt; registry -&gt; trips)</p></li>
<li><p><strong>Merge with full datasets</strong>: Combines matched subset with all
unmatched surveys and trips</p></li>
<li><p><strong>Upload to cloud storage</strong>: Saves merged data as versioned parquet file</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="logging">Logging<a class="anchor" aria-label="anchor" href="#logging"></a></h2>


<p>The function logs progress at each step:</p><ul><li><p>Loading device registry</p></li>
<li><p>Loading validated surveys</p></li>
<li><p>Loading GPS trips from cloud storage</p></li>
<li><p>Number of PDS surveys being matched</p></li>
<li><p>Merging with full datasets</p></li>
<li><p>Final counts (total records and matched pairs)</p></li>
<li><p>Uploading merged data to cloud storage</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="pipeline-integration">Pipeline Integration<a class="anchor" aria-label="anchor" href="#pipeline-integration"></a></h2>


<p>This function is typically run after:</p><ol><li><p><code><a href="ingest_kefs_surveys_v2.html">ingest_kefs_surveys_v2()</a></code> - Downloads raw data from Kobo</p></li>
<li><p><code><a href="preprocess_kefs_surveys_v2.html">preprocess_kefs_surveys_v2()</a></code> - Cleans and standardizes surveys</p></li>
<li><p><code><a href="validate_kefs_surveys_v2.html">validate_kefs_surveys_v2()</a></code> - Validates catch data</p></li>
<li><p><code><a href="ingest_pds_trips.html">ingest_pds_trips()</a></code> and <code><a href="preprocess_pds_tracks.html">preprocess_pds_tracks()</a></code> - Preprocessed PDS trips data must be available in cloud storage</p></li>
</ol><p>The output can be downloaded using:</p><div class="sourceCode"><pre><code><span></span>
<span><span class="va">merged_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_parquet_from_cloud.html">download_parquet_from_cloud</a></span><span class="op">(</span></span>
<span>  prefix <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">surveys</span><span class="op">$</span><span class="va">kefs</span><span class="op">$</span><span class="va">v2</span><span class="op">$</span><span class="va">merged</span>,</span>
<span>  provider <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">storage</span><span class="op">$</span><span class="va">google</span><span class="op">$</span><span class="va">key</span>,</span>
<span>  options <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">storage</span><span class="op">$</span><span class="va">google</span><span class="op">$</span><span class="va">options</span></span>
<span><span class="op">)</span></span></code></pre></div>

    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Standard usage - merges and uploads to cloud</span></span></span>
<span class="r-in"><span><span class="va">conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="read_config.html">read_config</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">merge_trips</span><span class="op">(</span><span class="va">conf</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Download the merged data to analyze</span></span></span>
<span class="r-in"><span><span class="va">merged_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="download_parquet_from_cloud.html">download_parquet_from_cloud</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  prefix <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">surveys</span><span class="op">$</span><span class="va">kefs</span><span class="op">$</span><span class="va">v2</span><span class="op">$</span><span class="va">merged</span>,</span></span>
<span class="r-in"><span>  provider <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">storage</span><span class="op">$</span><span class="va">google</span><span class="op">$</span><span class="va">key</span>,</span></span>
<span class="r-in"><span>  options <span class="op">=</span> <span class="va">conf</span><span class="op">$</span><span class="va">storage</span><span class="op">$</span><span class="va">google</span><span class="op">$</span><span class="va">options</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Count matched vs unmatched</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  survey <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">merged_data</span><span class="op">$</span><span class="va">submission_id</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  trip <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">merged_data</span><span class="op">$</span><span class="va">trip</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lorenzo Longobardi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

